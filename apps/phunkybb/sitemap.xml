<?xml version="1.0"?>
<map:sitemap xmlns:map="http://www.nexista.org/sitemap">
    <map:prepend>
        <map:script src="lib/php/config_check.php"/>
        <map:perl src="lib/perl/config_build.pl"/>
        <map:if name="/_R_/config_cache">
            <map:false>
                <map:query src="data/sql/config_get.xml"/>
                <map:script src="lib/php/config_build.php"/>
                <map:script src="lib/php/config_check.php"/>
                <map:perl src="lib/perl/config_build.pl"/>
            </map:false>
        </map:if>
        <map:set name="selected_lang" value="en_US"/>
        <map:script src="lib/php/runtime.php"/>
        <map:xml src="data/xml/menu.xml"/>
        <map:xml src="i18n/{/_R_/selected_lang}/phunkybb.xml"/>
    </map:prepend>

<!-- SESSIONS -->
<map:gate name="register">
    <map:xsl src="templates/xsl/register.xsl"/>
</map:gate>

<map:gate name="x-register">
    <map:if name="/_R_/_post">
        <map:true>
          <map:xml src="i18n/{//selected_lang}/emails.xml"/>
          <map:xml src="data/xml/emails.xml"/>
          <map:if name="//use_random_pass">
              <map:true>
                  <map:plugin type="random" params="random_password,8"/>
                  <map:plugin type="hash" params="sha1,//random_password"/>
              </map:true>
              <map:false>
                  <map:plugin type="decrypt_rsa" params="{//defaults/private_key},//_post/password"/>
                  <map:plugin type="hash" params="sha1,//_post/password"/>
              </map:false>
          </map:if>


          <map:plugin type="random" params="activation_key,4"/>
          <map:set name="my_registration_info" value="Registration Info"/>
          <map:plugin type="detokenize"
              params="{/_R_/i18n/welcome_email},//emails/welcome/token"/>
          <map:action type="email"
              params="{//_post/email},{//board_config/o_webmaster_email},{//my_registration_info},{//new_text},{//board_config/o_smtp_host}"/>
              <map:xsl src="templates/xsl/register.xsl"/>
              <map:query src="data/sql/user_register.xml"/>





        </map:true>
        <map:false>
            <map:action type="header" params="Content-type,text/xml"/>
            <map:set name="error_message" value="No post."/>
            <map:xsl src="templates/xml/error.xml.xsl"/>
        </map:false>
    </map:if>
</map:gate>
<map:gate name="registered">
    <map:xsl src="templates/xsl/registered.xsl"/>
</map:gate>
<map:gate name="activate">
    <map:query src="data/sql/user_activate.xml"/>
    <map:xsl src="templates/xsl/activate.xsl"/>
</map:gate>

    <map:gate name="login">
        <map:if name="//_post">
            <map:true>
                <map:plugin type="hash" params="sha1,//_post/password"/>
                <map:query src="data/sql/user_login.xml"/>
            </map:true>
        </map:if>
        <!-- this should be used if the user doesn't have javascript? -->
        <map:if name="//user_login/user_login">
            <map:true>
                <map:script src="lib/php/sessions.php"/>
                <map:action type="redirect" params="{/_R_/runtime/link_prefix}index"/>
            </map:true>
        </map:if>
        <map:xsl src="templates/xsl/login.xsl"/>
    </map:gate>
    <map:gate name="x-login" cache="0">
        <map:action type="header" params="Content-Type,text/xml"/>
        <map:plugin type="decrypt_rsa" params="{//defaults/private_key},//_post/password"/>
        <map:plugin type="hash" params="sha1,//_post/password"/>
        <map:query src="data/sql/user_login.xml"/>
        <map:if name="/_R_/user_login/user_login">
            <map:true>
                <map:query src="data/sql/user_last_visit_update.xml"/>
                <map:script src="lib/php/sessions.php"/>
            </map:true>
            <map:false>
                <map:xsl src="templates/xml/error.xml.xsl"/>
            </map:false>
        </map:if>
    </map:gate>
    <map:gate name="logout">
        <map:script src="lib/php/logout.php"/>
        <map:action type="redirect" params="{/_R_/runtime/link_prefix}"/>
    </map:gate>

    <map:gate name="index"
      cache="300"
      content_type="text/html"
      cache_control="no-cache, max-age=20, must-revalidate"
      >
        <map:query src="data/sql/categories_get_all.xml"/>
        <map:query src="data/sql/forums_get_all.xml"/>
        <map:action type="datetime" params="/_R_/forums_get_all/forums_get_all/last_post,unix_epoch,{/_R_/runtime/user_time_format},{/_R_/runtime/user_timezone_offset}"/>
        <map:xsl src="templates/xsl/welcome.xsl"/>
    </map:gate>

    <map:gate name="forum">
        <map:query src="data/sql/forum_get_by_id.xml"/>
        <map:query src="data/sql/topics_get_by_forum_id.xml"/>
        <map:action type="datetime" params="/_R_/topics_get_by_forum_id/topics_get_by_forum_id/last_post,unix_epoch,{/_R_/runtime/user_time_format},{//runtime/user_timezone_offset}"/>
        <map:xsl src="templates/xsl/forum.xsl"/>
    </map:gate>
    
    <map:gate name="topic">
        <map:query src="data/sql/forum_get_by_id.xml"/>
        <map:query src="data/sql/topic_get_by_id.xml"/>
        <map:query src="data/sql/posts_get_by_topic_id.xml"/>
        <map:query src="data/sql/posts_get_number_of_pages.xml"/>
        <map:action type="datetime" params="/_R_/posts_get_by_topic_id/posts_get_by_topic_id/posted,unix_epoch,{//runtime/user_time_format},{//runtime/user_timezone_offset}"/>
        <map:xsl src="templates/xsl/topic.xsl"/>
    </map:gate>
    <map:gate name="x-topic-delete" role="phunky_admin">
        <map:query src="data/sql/topic_delete.xml"/>
    </map:gate>
    <map:gate name="topic-submit">
        <map:query src="data/sql/topic_create.xml"/>
        <map:query src="data/sql/topic_get_id_by_detail.xml"/>
        <map:query src="data/sql/post_create_first.xml"/>
        <map:query src="data/sql/forum_last_post_update.xml"/>
        <!-- TODO - process subscription signups -->
        <map:action type="redirect" params="{/_R_/runtime/link_prefix}topic&amp;fid={//_post/forum_id}&amp;id={//topic_get_id_by_detail/id}"/>
    </map:gate>
    <map:gate name="post">
        <map:if name="//_post">
            <map:true>
                <map:plugin type="safehtml" params="//_post/message,clean_message"/>
                <map:action type="newline" params="//clean_message"/>
                <map:query src="data/sql/post_create.xml"/>
                <map:query src="data/sql/topic_last_post_update.xml"/>
                <map:query src="data/sql/forum_last_post_update.xml"/>
                <map:query src="data/sql/user_last_post_update.xml"/>
                <!-- TODO - process subscription mailing -->
                <map:action type="redirect"
                    params="{/_R_/runtime/link_prefix}topic&amp;fid={//_post/forum_id}&amp;id={//_post/topic_id}"/>
            </map:true>
            <map:false>
                <map:xsl src="templates/xsl/post.xsl"/>
            </map:false>
        </map:if>
    </map:gate>
    <map:gate name="post-edit">
        <map:if name="//_post">
            <map:true>
                <map:plugin type="safehtml" params="//_post/message,clean_message"/>
                <map:action type="newline" params="//clean_message"/>
                <map:query src="data/sql/post_update.xml"/>
                <map:action type="redirect"
                    params="{/_R_/runtime/link_prefix}topic&amp;post_id={//_post/post_id}"/>
            </map:true>
            <map:false>
                <map:query src="data/sql/post_get_by_id.xml"/>
                <map:xsl src="templates/xsl/post_edit.xsl"/>
            </map:false>
        </map:if>
    </map:gate>
    <map:gate name="x-post-delete" role="phunky_admin">
        <map:query src="data/sql/post_delete.xml"/>
        <map:query src="date/sql/topic_set_num_replies.xml"/>
    </map:gate>

    <!-- Profile -->
    <map:gate name="profile" role="phunky_user">
        <map:if name="/_R_/_post">
            <map:true>
                <map:query src="data/sql/user_update_essentials.xml"/>
                <map:action type="redirect" params="{/_R_/runtime/link_prefix}profile"/>
            </map:true>
            <map:false>
              <map:query src="data/sql/user_get_profile.xml"/>
              <map:action type="datetime" params="/_R_/user_get_profile/user_get_profile/last_visit,unix_epoch,{/_R_/runtime/user_time_format},{/_R_/runtime/user_timezone_offset}"/>
              <map:action type="datetime" params="/_R_/user_get_profile/user_get_profile/last_post,unix_epoch,{/_R_/runtime/user_time_format},{/_R_/runtime/user_timezone_offset}"/>
              <map:action type="datetime" params="/_R_/user_get_profile/user_get_profile/registered,unix_epoch,{/_R_/runtime/user_time_format},{/_R_/runtime/user_timezone_offset}"/>
              <map:xsl src="templates/xsl/profile.xsl"/>
            </map:false>
        </map:if>
    </map:gate>
    <map:gate name="password" role="phunky_user">
        <map:if name="//_post">
            <map:true>
        <map:plugin type="decrypt_rsa" params="{//defaults/private_key},//_post/password"/>
                <map:plugin type="hash" params="sha1,//_post/password"/>
                <map:query src="data/sql/user_update_password.xml"/>
                <map:action type="redirect" params="{/_R_/runtime/link_prefix}profile"/>
            </map:true>
            <map:false>
            <map:xsl src="templates/xsl/password.xsl"/>
            </map:false>
        </map:if>
    </map:gate>
    <map:gate name="personality" role="phunky_user">
    <map:if name="//_post">
        <map:true>
            <!--
            <map:plugin type="striptags" params="{//_post/signature}"/>
            -->
            <map:plugin type="bbcode" params="//_post/signature,unbb_text"/>
            <map:plugin type="safehtml" params="//unbb_text,html_text"/>
            <map:query src="data/sql/user_update_profile.xml"/>
            <map:action type="redirect" params="{/_R_/runtime/link_prefix}personality"/>
        </map:true>
        <map:false>
            <map:query src="data/sql/user_get_profile.xml"/>
            <map:xsl src="templates/xsl/personality.xsl"/>
        </map:false>
    </map:if>
    </map:gate>
    <map:gate name="user-admin" role="phunky_user">
        <map:query src="data/sql/user_get_profile.xml"/>
        <map:action type="datetime" params="//user_get_profile/last_visit,unix_epoch,{//runtime/user_time_format},{//runtime/user_timezone_offset}"/>
        <map:action type="datetime" params="//user_get_profile/registered,unix_epoch,{//runtime/user_time_format},{//runtime/user_timezone_offset}"/>
        <map:xsl src="templates/xsl/user_admin.xsl"/>
    </map:gate>

    <!-- REAL ADMIN -->
    <map:gate name="admin" role="phunky_admin">
        <map:xsl src="templates/xsl/admin.xsl"/>
    </map:gate>
    <map:gate name="options" role="phunky_admin">
        <map:xsl src="templates/xsl/admin_options.xsl"/>
    </map:gate>
    <map:gate name="options-submit" role="phunky_admin">
        <map:if name="//_post">
            <map:true>
                <map:query src="data/sql/config_delete.xml"/>
                <map:query src="data/sql/config_update.xml"/>
                <map:query src="data/sql/config_get.xml"/>
                <map:script src="lib/php/config_build.php"/>
                <map:action type="redirect" params="{/_R_/runtime/link_prefix}options"/>
            </map:true>
            <map:false>
            </map:false>
        </map:if>
    </map:gate>
    <map:gate name="categories" role="phunky_admin">
      <map:if name="/_R_/_post">
        <map:true>
        <map:switch name="/_R_/_post/action">
            <map:case value="add_cat">
                <map:query src="data/sql/category_create.xml"/>
                <map:action type="redirect" params="{/_R_/runtime/link_prefix}categories"/>
            </map:case>
            <map:case value="del_cat">
                <map:query src="data/sql/category_delete.xml"/>
                <map:action type="redirect" params="{/_R_/runtime/link_prefix}categories"/>
            </map:case>
            <map:default>
            </map:default>
        </map:switch>
        </map:true>
        <map:false>
        </map:false>
      </map:if>
      <map:query src="data/sql/categories_get_all.xml"/>
      <map:xsl src="templates/xsl/admin_categories.xsl"/>
    </map:gate>
    <map:gate name="forums" role="phunky_admin">
        <map:if name="//_post">
            <map:true>
                <map:query src="data/sql/forum_create.xml"/>
                <map:action type="redirect" params="{/_R_/runtime/link_prefix}forums"/>
            </map:true>
            <map:false>
            </map:false>
        </map:if>
        <map:query src="data/sql/categories_get_all.xml"/>
        <map:query src="data/sql/forums_get_all.xml"/>
        <map:xsl src="templates/xsl/admin_forum.xsl"/>
    </map:gate>
    <map:gate name="forum-edit" role="phunky_admin">
        <map:if name="//_post">
            <map:true>
                <map:query src="data/sql/forum_update.xml"/>
                <map:action type="redirect" params="{/_R_/runtime/link_prefix}forums"/>
            </map:true>
            <map:false>
            </map:false>
        </map:if>
        <map:query src="data/sql/categories_get_all.xml"/>
        <map:query src="data/sql/forum_get_by_id.xml"/>
        <map:xsl src="templates/xsl/admin_forum_edit.xsl"/>
    </map:gate>
    <map:gate name="x-forum-delete" role="phunky_admin">
        <map:query src="data/sql/forum_delete.xml"/>
    </map:gate>
    <map:gate name="users" role="phunky_admin">
        <map:query src="data/sql/users_get_all.xml"/>
        <map:xsl src="templates/xsl/admin_users.xsl"/>
    </map:gate>
    <map:gate name="x-user-delete" role="phunky_admin">
        <map:query src="data/sql/user_delete.xml"/>
    </map:gate>
    <map:gate name="user-email" role="phunky_admin">
        <map:if name="//_post">
            <map:true>
                <map:xml src="data/xml/emails.xml"/>
                <map:xml src="i18n/en_US/emails.xml"/>
                <map:plugin type="detokenize"
                    params="{/_R_/i18n/test_email},//emails/test/token"/>
                <map:action type="email"
                    params="{//_post/rcpt_email},{//board_config/o_webmaster_email},{//_post/subject},{//new_text},{//board_config/o_smtp_host}"/>
                <map:action type="redirect" params="{/_R_/runtime/link_prefix}user-email&amp;user_id={//_post/user_id}"/>
            </map:true>
            <map:false>
                <map:query src="data/sql/user_get_profile.xml"/>
                <map:xsl src="templates/xsl/user_email.xsl"/>
            </map:false>
        </map:if>
    </map:gate>


    <map:gate name="dynamic-css"
      cache="600"
      nosession="true"
      content_type="text/css"
      cache_control="public, max-age=600, must-revalidate">
<map:xml src="data/xml/pastel_css.xml"/>

        <map:xsl src="templates/css/dynamic.css.xsl"/>
    </map:gate>


    <map:gate name="install">
        <map:xsl src="templates/xsl/install.xsl"/>
    </map:gate>
    <map:gate name="dynamic-database-model">
        <map:if name="//defaults/install_settings">
            <map:true>
            </map:true>
            <map:false>
                <map:set name="admin" value="admin"/>
                <!-- default password is phunkybb -->
                <map:set name="password" value="f20f7f3c358148d57be1a241e9d7d7199642afbb"/>
                <map:set name="email" value="email@example.com"/>
            </map:false>
        </map:if>
        <map:set name="table_prefix" value="wwwneofilmzcom_"/>
        <map:action type="header" params="Content-type,text/plain"/>
        <map:xsl src="data/model/phunkybb_database.sql.xsl"/>
    </map:gate>


    <map:gate name="license">
        <map:raw src="LICENSE"/>
    </map:gate>


    <map:gate name="ml-test">
        <map:xml src="templates/xsl/login.xsl"/>
        <map:xsl src="templates/tests/test_runner.xsl"/>
    </map:gate>

</map:sitemap>
