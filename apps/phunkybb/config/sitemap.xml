<map:sitemap xmlns:map="http://www.nexista.org/sitemap"> 
    <map:prepend>
        <map:script src="lib/php/config_check.php"/>
        <map:if name="//config_cache">
            <map:true>
                <map:xml src="../../cache/dev-2/phunkybb/config_cache.xml"/>
            </map:true>
            <map:false>
                <map:query src="data/sql/config_get.xml"/>
                <map:script src="lib/php/config_build.php"/>
            </map:false>
        </map:if>
        <map:script src="lib/php/runtime.php"/>
        <map:xml src="data/xml/menu.xml"/>
        <map:xml src="i18n/en_US/phunkybb.xml"/>
    </map:prepend>

<!-- SESSIONS -->
<map:gate name="register">
    <map:xml src="data/xml/tzdata.xml"/>
    <map:if name="//_post">
        <map:true>
            <map:validate src="validators/registration_validation.xml">
                <map:valid>
                    <map:xml src="data/xml/emails.xml"/>
                    <map:plugin type="hash" params="sha1,//_post/password"/>
                    <map:plugin type="detokenize" 
                        params="{//label[key='welcome_email']/value},//emails/email/token"/>
                    <map:action type="email" 
                        params="{//_post/email},{//board_config/o_webmaster_email},Reg Info,{//new_text},{//board_config/o_smtp_host}"/>
                    <map:query src="data/sql/user_register.xml"/>
                    <map:action type="redirect" params="{//link_prefix}registered"/>
                </map:valid>
                <map:invalid>
                    <map:xsl src="templates/xsl/register.xsl"/>
                </map:invalid>
            </map:validate>
        </map:true>
        <map:false>
            <map:xsl src="templates/xsl/register.xsl"/>
        </map:false>
    </map:if>
</map:gate>
<map:gate name="registered">
    <map:xsl src="templates/xsl/registered.xsl"/>
</map:gate>

    <map:gate name="login">
        <map:if name="//_post">
            <map:true>
                <map:plugin type="hash" params="sha1,//_post/password"/>
                <map:query src="data/sql/user_login.xml"/>
            </map:true>
            <map:false>
                <map:xsl src="templates/xsl/login.xsl"/>
            </map:false>
        </map:if>
        <map:if name="//user_login">
            <map:true>
                <map:script src="lib/php/sessions.php"/>
                <!--<map:action type="redirect" params="{//link_prefix}index"/>-->
            </map:true>
            <map:false>
            </map:false>
        </map:if>
    </map:gate>
    <map:gate name="ajax-check" cache="0">
        <map:action type="header" params="Content-Type,text/xml"/>
        <map:script src="lib/php/rsa_decrypt.php"/>
        <map:plugin type="hash" params="sha1,//cleartext"/>
        <map:query src="data/sql/user_login.xml"/>
        <map:if name="//user_login">
            <map:true>
                <map:script src="lib/php/sessions.php"/>
            </map:true>
            <map:false>
                <map:script src="lib/php/fail.php"/>
            </map:false>
        </map:if>
    </map:gate>
    <map:gate name="logout">
        <map:script src="lib/php/logout.php"/>
        <map:action type="redirect" params="{//link_prefix}"/>
    </map:gate>
    
    
    
    <map:gate name="index">
        <map:block name="index">
            <map:query src="data/sql/categories_get_all.xml"/>
            <map:query src="data/sql/forums_get_all.xml"/>
            <map:xsl src="templates/xsl/welcome.xsl"/>
        </map:block>
    </map:gate>
    <map:gate name="welcome">
        <map:insert name="index"/>
    </map:gate>
    <map:gate name="forum">
        <map:query src="data/sql/forum_get_by_id.xml"/>
        <map:query src="data/sql/topics_get_by_forum_id.xml"/>
        <map:xsl src="templates/xsl/forum.xsl"/>
    </map:gate>
    <map:gate name="topic">
        <map:query src="data/sql/forum_get_by_id.xml"/>
        <map:query src="data/sql/topic_get_by_id.xml"/>
        <map:query src="data/sql/posts_get_by_topic_id.xml"/>
        <map:xsl src="templates/xsl/topic.xsl"/>
    </map:gate>
    <map:gate name="topic-submit">
        <map:query src="data/sql/topic_create.xml"/>
        <map:query src="data/sql/topic_get_id_by_detail.xml"/>
        <map:query src="data/sql/post_create_first.xml"/>
        <map:action type="redirect" params="{//link_prefix}topic&amp;submit=yes&amp;id={//topic_get_id_by_detail/id}"/>
    </map:gate>
    <map:gate name="post">
        <map:if name="//_post">
            <map:true>
                <map:query src="data/sql/post_create.xml"/>
                <map:action type="redirect" params="{//link_prefix}topic&amp;id={//_post/topic_id}"/>
            </map:true>
            <map:false>
                <map:xsl src="templates/xsl/post.xsl"/>
            </map:false>
        </map:if>
    </map:gate>

    <!-- Profile -->
    <map:gate name="profile" role="phunky_user">
        <map:xml src="data/xml/tzdata.xml"/>
        <map:query src="data/sql/user_get_profile.xml"/>
        <map:xsl src="templates/xsl/profile.xsl"/>
    </map:gate>
    <map:gate name="personality" role="phunky_user">
        <map:query src="data/sql/user_get_profile.xml"/>
        <map:xsl src="templates/xsl/personality.xsl"/>
    </map:gate>
    <map:gate name="display" role="phunky_user">
        <map:query src="data/sql/user_get_profile.xml"/>
        <map:xsl src="templates/xsl/display.xsl"/>
    </map:gate>
    <map:gate name="privacy" role="phunky_user">
        <map:query src="data/sql/user_get_profile.xml"/>
        <map:xsl src="templates/xsl/privacy.xsl"/>
    </map:gate>
    <map:gate name="user-admin" role="phunky_user">
        <map:query src="data/sql/user_get_profile.xml"/>
        <map:xsl src="templates/xsl/user_admin.xsl"/>
    </map:gate>
    
    
    
    
    
    
    <!-- REAL ADMIN -->
    <map:gate name="admin" role="phunky_admin">
        <map:xsl src="templates/xsl/admin.xsl"/>
    </map:gate>
    <map:gate name="options" role="phunky_admin">
        <map:xml src="data/xml/tzdata.xml"/>
        <map:xsl src="templates/xsl/admin_options.xsl"/>
    </map:gate>
    <map:gate name="options-submit" role="phunky_admin">
        <map:if name="//_post">
            <map:true>
                <map:query src="data/sql/config_delete.xml"/>
                <map:query src="data/sql/config_update.xml"/>
                <map:query src="data/sql/config_get.xml"/>
                <map:script src="lib/php/config_build.php"/>
                <map:action type="redirect" params="{//link_prefix}options"/>
            </map:true>
            <map:false>
            </map:false>
        </map:if>
    </map:gate>
    <map:gate name="categories" role="phunky_admin">
        <map:switch name="//_post/action">
            <map:case value="add_cat">
                <map:query src="data/sql/category_create.xml"/>
                <map:action type="redirect" params="{//link_prefix}categories"/>
            </map:case>
            <map:case value="del_cat">
                <map:query src="data/sql/category_delete.xml"/>
                <map:action type="redirect" params="{//link_prefix}categories"/>
            </map:case>
            <map:default>
            </map:default>
        </map:switch>
        <map:query src="data/sql/categories_get_all.xml"/>
        <map:xsl src="templates/xsl/admin_categories.xsl"/>
    </map:gate>
    <map:gate name="forums" role="phunky_admin">
        <map:if name="//_post">
            <map:true>
                <map:query src="data/sql/forum_create.xml"/>
                <map:action type="redirect" params="{//link_prefix}forums"/>
            </map:true>
            <map:false>
            </map:false>
        </map:if>
        <map:query src="data/sql/categories_get_all.xml"/>
        <map:query src="data/sql/forums_get_all.xml"/>
        <map:xsl src="templates/xsl/admin_forum.xsl"/>
    </map:gate>
    <map:gate name="forum-delete" role="phunky_admin">
        <map:query src="data/sql/forum_delete.xml"/>
    </map:gate>
    <map:gate name="users" role="phunky_admin">
        <map:query src="data/sql/users_get_all.xml"/>
        <map:xsl src="templates/xsl/admin_users.xsl"/>
    </map:gate>
    <map:gate name="x-user-delete" role="phunky_admin">
        <map:query src="data/sql/user_delete.xml"/>
    </map:gate>
    <!--
    <map:gate name="groups" role="phunky_admin">
        <map:xsl src="templates/xsl/admin.xsl"/>
    </map:gate>
    <map:gate name="permissions" role="phunky_admin">
        <map:xsl src="templates/xsl/admin.xsl"/>
    </map:gate>
    <map:gate name="censoring" role="phunky_admin">
        <map:xsl src="templates/xsl/admin.xsl"/>
    </map:gate>
    <map:gate name="ranks" role="phunky_admin">
        <map:xsl src="templates/xsl/admin.xsl"/>
    </map:gate>
    <map:gate name="bans" role="phunky_admin">
        <map:xsl src="templates/xsl/admin.xsl"/>
    </map:gate>
    <map:gate name="prune" role="phunky_admin">
        <map:xsl src="templates/xsl/admin.xsl"/>
    </map:gate>
    <map:gate name="maintenance" role="phunky_admin">
        <map:xsl src="templates/xsl/admin.xsl"/>
    </map:gate>  
    -->
    
</map:sitemap>