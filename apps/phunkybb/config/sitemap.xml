<!--
Program: PhunkyBB
Component: sitemap.xml
Copyright: Savonix Corporation
Author: Albert L. Lash, IV
License: Gnu Affero Public License version 3
http://www.gnu.org/licenses

This program is free software; you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation; either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program; if not, see http://www.gnu.org/licenses
or write to the Free Software Foundation,Inc., 51 Franklin Street,
Fifth Floor, Boston, MA 02110-1301  USA
-->
<map:sitemap xmlns:map="http://www.nexista.org/sitemap">
    <map:prepend>
        <map:action type="server"/>
        <map:script src="lib/php/config_check.php"/>
        <map:if name="//config_cache">
            <map:true>
            </map:true>
            <map:false>
                <map:query src="data/sql/config_get.xml"/>
                <map:script src="lib/php/config_build.php"/>
            </map:false>
        </map:if>
        <map:script src="lib/php/runtime.php"/>
        <map:xml src="data/xml/menu.xml"/>
        <map:xml src="i18n/en_US/phunkybb.xml"/>
    </map:prepend>

<!-- SESSIONS -->
<map:gate name="register">
    <map:xml src="data/xml/tzdata.xml"/>
    <map:if name="//_post">
        <map:true>
            <map:validate src="validators/registration_validation.xml">
                <map:valid>
                    <map:xml src="i18n/{//selected_lang}/emails.xml"/>
                    <map:xml src="data/xml/emails.xml"/>
                    <map:plugin type="random" params="random,8"/>
                    <map:plugin type="hash" params="sha1,//_post/password"/>
                    <map:plugin type="detokenize" 
                        params="{//label[key='welcome_email']/value},//emails/email/token"/>
                    <map:action type="email" 
                        params="{//_post/email},{//board_config/o_webmaster_email},Reg Info,{//new_text},{//board_config/o_smtp_host}"/>
                    <map:query src="data/sql/user_register.xml"/>
                    <map:action type="redirect" params="{//link_prefix}registered"/>
                </map:valid>
                <map:invalid>
                    <map:xsl src="templates/xsl/register.xsl"/>
                </map:invalid>
            </map:validate>
        </map:true>
        <map:false>
            <map:xsl src="templates/xsl/register.xsl"/>
        </map:false>
    </map:if>
</map:gate>
<map:gate name="registered">
    <map:xsl src="templates/xsl/registered.xsl"/>
</map:gate>
<map:gate name="activate">
    <map:query src="data/sql/user_activate.xml"/>
    <map:xsl src="templates/xsl/activate.xsl"/>
</map:gate>

    <map:gate name="login">
        <map:if name="//_post">
            <map:true>
                <map:plugin type="hash" params="sha1,//_post/password"/>
                <map:query src="data/sql/user_login.xml"/>
            </map:true>
            <map:false>
                <map:xsl src="templates/xsl/login.xsl"/>
            </map:false>
        </map:if>
        <map:if name="//user_login">
            <map:true>
                <map:script src="lib/php/sessions.php"/>
                <map:query src="data/sql/user_last_visit_update.xml"/>
                <map:action type="redirect" params="{//link_prefix}index"/>
            </map:true>
            <map:false>
            </map:false>
        </map:if>
    </map:gate>
    <map:gate name="ajax-check" cache="0">
        <map:action type="header" params="Content-Type,text/xml"/>
        <map:script src="lib/php/rsa_decrypt.php"/>
        <map:plugin type="hash" params="sha1,//cleartext"/>
        <map:query src="data/sql/user_login.xml"/>
        <map:if name="//user_login">
            <map:true>
                <map:script src="lib/php/sessions.php"/>
            </map:true>
            <map:false>
                <map:script src="lib/php/fail.php"/>
            </map:false>
        </map:if>
    </map:gate>
    <map:gate name="logout">
        <map:script src="lib/php/logout.php"/>
        <map:action type="redirect" params="{//link_prefix}"/>
    </map:gate>

    <map:gate name="index" cache="60" client_cache="30">
        <map:block name="index">
            <map:query src="data/sql/categories_get_all.xml"/>
            <map:query src="data/sql/forums_get_all.xml"/>
            <map:query src="data/sql/forums_get_totals.xml"/>
            <map:action type="datetime" params="//forums_get_all/last_post,unix_epoch,{//runtime/user_time_format},{//runtime/user_timezone_offset}"/>
            <map:xsl src="templates/xsl/welcome.xsl"/>
        </map:block>
    </map:gate>
    <map:gate name="welcome" cache="60" client_cache="30">
        <map:insert name="index"/>
    </map:gate>
    <map:gate name="forum">
        <map:query src="data/sql/forum_get_by_id.xml"/>
        <map:query src="data/sql/topics_get_by_forum_id.xml"/>
        <map:action type="datetime" params="//topics_get_by_forum_id/last_post,unix_epoch,{//runtime/user_time_format},{//runtime/user_timezone_offset}"/>
        <map:xsl src="templates/xsl/forum.xsl"/>
    </map:gate>
    <map:gate name="topic">
        <map:query src="data/sql/forum_get_by_id.xml"/>
        <map:query src="data/sql/topic_get_by_id.xml"/>
        <map:query src="data/sql/posts_get_by_topic_id.xml"/>
        <map:query src="data/sql/posts_get_number_of_pages.xml"/>
        <map:action type="datetime" params="//posts_get_by_topic_id/posted,unix_epoch,{//runtime/user_time_format},{//runtime/user_timezone_offset}"/>
        <map:xsl src="templates/xsl/topic.xsl"/>
    </map:gate>
    <map:gate name="x-topic-delete" role="phunky_admin">
        <map:query src="data/sql/topic_delete.xml"/>
    </map:gate>
    <map:gate name="topic-submit">
        <map:query src="data/sql/topic_create.xml"/>
        <map:query src="data/sql/topic_get_id_by_detail.xml"/>
        <map:query src="data/sql/post_create_first.xml"/>
        <map:query src="data/sql/forum_last_post_update.xml"/>
        <map:action type="redirect" params="{//link_prefix}topic&amp;fid={//_post/forum_id}&amp;id={//topic_get_id_by_detail/id}"/>
    </map:gate>
    <map:gate name="post">
        <map:if name="//_post">
            <map:true>
                <map:plugin type="safehtml" params="//_post/message,clean_message"/>
                <map:action type="newline" params="//clean_message"/>
                <map:query src="data/sql/post_create.xml"/>
                <map:query src="data/sql/topic_last_post_update.xml"/>
                <map:query src="data/sql/forum_last_post_update.xml"/>
                <map:query src="data/sql/user_last_post_update.xml"/>
                <map:action type="redirect"
                    params="{//link_prefix}topic&amp;fid={//_post/forum_id}&amp;id={//_post/topic_id}"/>
            </map:true>
            <map:false>
                <map:xsl src="templates/xsl/post.xsl"/>
            </map:false>
        </map:if>
    </map:gate>
    <map:gate name="x-post-delete" role="phunky_admin">
        <map:query src="data/sql/post_delete.xml"/>
        <map:query src="date/sql/topic_set_num_replies.xml"/>
    </map:gate>

    <!-- Profile -->
    <map:gate name="profile" role="phunky_user">
        <map:if name="//_post">
            <map:true>
                <map:query src="data/sql/user_update_essentials.xml"/>
                <map:action type="redirect" params="{//link_prefix}profile"/>
            </map:true>
            <map:false>
            <map:xml src="data/xml/tzdata.xml"/>
            <map:query src="data/sql/user_get_profile.xml"/>
            <map:action type="datetime" params="//user_get_profile/last_post,unix_epoch,{//runtime/user_time_format},{//runtime/user_timezone_offset}"/>
            <map:action type="datetime" params="//user_get_profile/registered,unix_epoch,{//runtime/user_time_format},{//runtime/user_timezone_offset}"/>
            <map:xsl src="templates/xsl/profile.xsl"/>
            </map:false>
        </map:if>
    </map:gate>
    <map:gate name="personality" role="phunky_user">
    <map:if name="//_post">
        <map:true>
            <!--
            <map:plugin type="striptags" params="{//_post/signature}"/>
            -->
            <map:plugin type="bbcode" params="//_post/signature,unbb_text"/>
            <map:plugin type="safehtml" params="//unbb_text,html_text"/>
            <map:query src="data/sql/user_update_profile.xml"/>
            <map:action type="redirect" params="{//link_prefix}personality"/>
        </map:true>
        <map:false>
            <map:query src="data/sql/user_get_profile.xml"/>
            <map:xsl src="templates/xsl/personality.xsl"/>
        </map:false>
    </map:if>
    </map:gate>
    <map:gate name="display" role="phunky_user">
        <map:query src="data/sql/user_get_profile.xml"/>
        <map:xsl src="templates/xsl/display.xsl"/>
    </map:gate>
    <map:gate name="privacy" role="phunky_user">
        <map:query src="data/sql/user_get_profile.xml"/>
        <map:xsl src="templates/xsl/privacy.xsl"/>
    </map:gate>
    <map:gate name="user-admin" role="phunky_user">
        <map:query src="data/sql/user_get_profile.xml"/>
        <map:action type="datetime" params="//user_get_profile/registered,unix_epoch,{//runtime/user_time_format},{//runtime/user_timezone_offset}"/>
        <map:xsl src="templates/xsl/user_admin.xsl"/>
    </map:gate>
    
    
    <!-- REAL ADMIN -->
    <map:gate name="admin" role="phunky_admin">
        <map:xsl src="templates/xsl/admin.xsl"/>
    </map:gate>
    <map:gate name="options" role="phunky_admin">
        <map:xml src="data/xml/tzdata.xml"/>
        <map:xsl src="templates/xsl/admin_options.xsl"/>
    </map:gate>
    <map:gate name="options-submit" role="phunky_admin">
        <map:if name="//_post">
            <map:true>
                <map:query src="data/sql/config_delete.xml"/>
                <map:query src="data/sql/config_update.xml"/>
                <map:query src="data/sql/config_get.xml"/>
                <map:script src="lib/php/config_build.php"/>
                <map:action type="redirect" params="{//link_prefix}options"/>
            </map:true>
            <map:false>
            </map:false>
        </map:if>
    </map:gate>
    <map:gate name="categories" role="phunky_admin">
        <map:switch name="//_post/action">
            <map:case value="add_cat">
                <map:query src="data/sql/category_create.xml"/>
                <map:action type="redirect" params="{//link_prefix}categories"/>
            </map:case>
            <map:case value="del_cat">
                <map:query src="data/sql/category_delete.xml"/>
                <map:action type="redirect" params="{//link_prefix}categories"/>
            </map:case>
            <map:default>
            </map:default>
        </map:switch>
        <map:query src="data/sql/categories_get_all.xml"/>
        <map:xsl src="templates/xsl/admin_categories.xsl"/>
    </map:gate>
    <map:gate name="forums" role="phunky_admin">
        <map:if name="//_post">
            <map:true>
                <map:query src="data/sql/forum_create.xml"/>
                <map:action type="redirect" params="{//link_prefix}forums"/>
            </map:true>
            <map:false>
            </map:false>
        </map:if>
        <map:query src="data/sql/categories_get_all.xml"/>
        <map:query src="data/sql/forums_get_all.xml"/>
        <map:xsl src="templates/xsl/admin_forum.xsl"/>
    </map:gate>
    <map:gate name="forum-delete" role="phunky_admin">
        <map:query src="data/sql/forum_delete.xml"/>
    </map:gate>
    <map:gate name="users" role="phunky_admin">
        <map:query src="data/sql/users_get_all.xml"/>
        <map:xsl src="templates/xsl/admin_users.xsl"/>
    </map:gate>
    <map:gate name="x-user-delete" role="phunky_admin">
        <map:query src="data/sql/user_delete.xml"/>
    </map:gate>
    <map:gate name="user-email" role="phunky_admin">
        <map:if name="//_post">
            <map:true>
                <map:action type="email"
                    params="{//_post/rcpt_email},{//board_config/o_webmaster_email},
                    Important,{//message},{//board_config/o_smtp_host}"/>
                <map:query src="data/sql/user_register.xml"/>
                <map:action type="redirect" params="{//link_prefix}profile&amp;user_id={//_post/user_id}"/>
            </map:true>
            <map:false>
                <map:query src="data/sql/user_get_profile.xml"/>
                <map:xsl src="templates/xsl/user_email.xsl"/>
            </map:false>
        </map:if>
    </map:gate>

    <map:gate name="install">
        <map:xsl src="templates/xsl/install.xsl"/>
    </map:gate>
    <map:gate name="dynamic-database-model">
        <map:if name="//defaults/install_settings">
            <map:true>
            </map:true>
            <map:false>
                <map:set name="admin" value="admin"/>
                <!-- default password is phunkybb -->
                <map:set name="password" value="f20f7f3c358148d57be1a241e9d7d7199642afbb"/>
                <map:set name="email" value="email@example.com"/>
            </map:false>
        </map:if>
        <map:set name="table_prefix" value="wwwneofilmzcom_"/>
        <map:action type="header" params="Content-type,text/plain"/>
        <map:xsl src="data/model/phunkybb_database.sql.xsl"/>
    </map:gate>
</map:sitemap>